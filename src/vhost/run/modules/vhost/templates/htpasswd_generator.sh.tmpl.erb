#!/usr/bin/env bash

if [ ! -d /etc/htpasswd/containers ]; then
  mkdir -p /etc/htpasswd/containers
fi

rm -rf /etc/htpasswd/containers/*

{{ range $vhost_project_name, $containers := groupByMulti $ "Env.VHOST_PROJECT_NAME" "," }}
  {{ range $container := $containers }}
    {{ if $container.Env.VHOST_HTTP_BASIC_AUTH_PASSWORD }}
      {{ if $container.Env.VHOST_HTTP_BASIC_AUTH_USERNAME }}
        htpasswd -b -c /etc/htpasswd/containers/{{ $vhost_project_name }}.{{ $container.Env.VHOST_SERVICE_NAME }}.htpasswd '{{ $container.Env.VHOST_HTTP_BASIC_AUTH_USERNAME }}' '{{ $container.Env.VHOST_HTTP_BASIC_AUTH_PASSWORD }}'
      {{ else }}
        htpasswd -b -c /etc/htpasswd/containers/{{ $vhost_project_name }}.{{ $container.Env.VHOST_SERVICE_NAME }}.htpasswd '<%= @http_basic_auth_username %>' '{{ $container.Env.VHOST_HTTP_BASIC_AUTH_PASSWORD }}'
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}
