<?php

$vhost = array();

{{ range $vhost_project_name, $containers := groupByMulti $ "Env.VHOST_PROJECT_NAME" "," }}
  if (!isset($vhost['{{ $vhost_project_name }}'])) {
    $vhost['{{ $vhost_project_name }}'] = array(
      'project_name' => '{{ $vhost_project_name }}',
      'services' => array(),
    );
  }

  {{ range $container := $containers }}
    {{ if ($container.Env.VHOST_PRIMARY_SERVICE) and (eq $container.Env.VHOST_PRIMARY_SERVICE "Yes") }}
      $vhost['{{ $vhost_project_name }}']['service_name'] = '{{ $container.Env.VHOST_SERVICE_NAME }}';
      $vhost['{{ $vhost_project_name }}']['urls'] = array();
      $vhost['{{ $vhost_project_name }}']['domain_aliases'] = array();

      {{ range $address := $container.Addresses }}
        {{ if eq $address.Port "80" }}
          $vhost['{{ $vhost_project_name }}']['urls'][{{ $address.Port }}] = 'http://{{ $vhost_project_name }}.<%= @server_name %>';
        {{ else if eq $address.Port "443" }}
          $vhost['{{ $vhost_project_name }}']['urls'][{{ $address.Port }}] = 'https://{{ $vhost_project_name }}.<%= @server_name %>';
        {{ end }}
      {{ end }}
    {{ end }}

    if (!isset($vhost['{{ $vhost_project_name }}']['services']['{{ $container.Env.VHOST_SERVICE_NAME }}'])) {
      $vhost['{{ $vhost_project_name }}']['services']['{{ $container.Env.VHOST_SERVICE_NAME }}'] = array(
        'service_name' => '{{ $container.Env.VHOST_SERVICE_NAME }}',
        'version' => '{{ $container.Image.Tag }}',
        'urls' => array(),
        'domain_aliases' => array(),
      );

      {{ if $container.Env.VHOST_VERSION_FILE }}
        $vhost['{{ $vhost_project_name }}']['services']['{{ $container.Env.VHOST_SERVICE_NAME }}']['version_file'] = '{{ $container.Env.VHOST_VERSION_FILE }}';
      {{ end }}

      {{ if $container.Env.VHOST_SOURCE_URL }}
        $vhost['{{ $vhost_project_name }}']['services']['{{ $container.Env.VHOST_SERVICE_NAME }}']['source_url'] = '{{ $container.Env.VHOST_SOURCE_URL }}';
      {{ end }}
    }

    {{ range $address := $container.Addresses }}
      {{ if eq $address.Port "80" }}
        $vhost['{{ $vhost_project_name }}']['services']['{{ $container.Env.VHOST_SERVICE_NAME }}']['urls'][{{ $address.Port }}] = 'http://{{ $container.Env.VHOST_SERVICE_NAME }}.{{ $vhost_project_name }}.<%= @server_name %>';
      {{ else if eq $address.Port "443" }}
        $vhost['{{ $vhost_project_name }}']['services']['{{ $container.Env.VHOST_SERVICE_NAME }}']['urls'][{{ $address.Port }}] = 'https://{{ $container.Env.VHOST_SERVICE_NAME }}.{{ $vhost_project_name }}.<%= @server_name %>';
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{ range $vhost_domain_alias, $containers := groupByMulti $ "Env.VHOST_DOMAIN_ALIASES" "," }}
  {{ range $container := $containers }}
    {{ if ($container.Env.VHOST_PRIMARY_SERVICE) and (eq $container.Env.VHOST_PRIMARY_SERVICE "Yes") }}
      {{ range $address := $container.Addresses }}
        {{ if eq $address.Port "80" }}
          $vhost['{{ $container.Env.VHOST_PROJECT_NAME }}']['domain_aliases']['{{ $vhost_domain_alias }}'] = 'http://{{ $vhost_domain_alias }}';
        {{ else if eq $address.Port "443" }}
          $vhost['{{ $container.Env.VHOST_PROJECT_NAME }}']['domain_aliases']['{{ $vhost_domain_alias }}'] = 'https://{{ $vhost_domain_alias }}';
        {{ end }}
      {{ end }}
    {{ end }}

    {{ range $address := $container.Addresses }}
      {{ if eq $address.Port "80" }}
        $vhost['{{ $container.Env.VHOST_PROJECT_NAME }}']['services']['{{ $container.Env.VHOST_SERVICE_NAME }}']['domain_aliases']['{{ $vhost_domain_alias }}'] = 'http://{{ $vhost_domain_alias }}';
      {{ else if eq $address.Port "443" }}
        $vhost['{{ $container.Env.VHOST_PROJECT_NAME }}']['services']['{{ $container.Env.VHOST_SERVICE_NAME }}']['domain_aliases']['{{ $vhost_domain_alias }}'] = 'https://{{ $vhost_domain_alias }}';
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}
